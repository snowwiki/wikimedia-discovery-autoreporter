---
params:
  report_title: "Explore similar pages, categories and suggested languages in search results"
  phab_ticket: "T149809"
  test_description: >
    This A/B test will have a test group that will be shown additional
    information that will be relevant to individual results on the existing
    search results page. This additional information will be links and
    metadata of related pages with links to related categories and suggested
    language links that are similar to the individual search results. A
    control group will see the currently existing search results page.
  data: "./data/Explore similar pages, categories and suggested languages in search results/events_raw_20170724112938.RData"
  query: "SELECT * FROM TestSearchSatisfaction2_16909631 LIMIT 100;"
  start_date: 20170713 # inclusive
  end_date: 20170723 # exclusive
  tss2_revision: 16909631
  wiki: enwiki
  test_group_names: [explore_similar_control, explore_similar_test]
  interleaved_group_names: [ltr-i-1024]
  event_action: [searchResultPage, click, ssclick, visitPage, checkin, hover-on, hover-off, esclick]
  event_source: "fulltext"
  other_filter: "event_subTest IS NOT NULL"
  serp_dwell_time: false # If true, dwell time of fulltext search result pages from autocomplete will be included
  debug: false # setting to false hides messages and warnings
title: '`r params$report_title`'
author: '`r paste("Generated by", ifelse(params$debug, Sys.info()["user"], "the automated A/B test reporting tool"))`'
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  html_document:
    # Table of Contents
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    code_folding: hide
    # Figures
    fig_width: 10
    fig_height: 6
    # Theme
    theme: flatly
    highlight: zenburn
    # Files
    self_contained: true
    keep_md: false
    # Extras
    mathjax: https://tools-static.wmflabs.org/cdnjs/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML
    md_extensions: +raw_html +markdown_in_html_blocks +tex_math_dollars +fancy_lists +startnum +lists_without_preceding_blankline -autolink_bare_uris
---
```{js, echo=FALSE}
$( function() {
  /* Lets the user click on the images to view them in full resolution. */
  $( "img" ).wrap( function() {
    var link = $( '<a/>' );
    link.attr( 'href', $( this ).attr( 'src' ));
    link.attr( 'target', '_blank' );
    return link;
  } );
} );
```
```{css, echo=FALSE}
/* Differentiate sub-tabs from tabs by using its complement */
div.tab-content a[role=tab] {
  color: #BC1838;
}
/* When sub-tab is active, set the color to #2c3e50*/
ul.nav-tabs li.active a[role=tab] {
  color: #2c3e50;
}
```
```{r setup, echo=FALSE, error=TRUE, message=params$debug, warning=params$debug}
############## Read parameters for debugging ################
if (length(rmarkdown::metadata) == 0) {
  params <- rmarkdown::yaml_front_matter("report.Rmd")$params
}
#############################################################
knitr::opts_chunk$set(
  error = TRUE, echo = FALSE, message = params$debug, warning = params$debug
)
```

```{r print_query, results='asis', eval=is.null(params$data)}
cat("**Query for full-text events**:\n\n```SQL\n", query, "\n```\n")
if (params$serp_dwell_time) {
  cat("**Query for SERP from autocomplete**:\n\n```SQL\n", query_autocomplete, "\n```\n")
}
```

`r if (!is.null(params$test_description)) { params$test_description }`

This test ran from `r min_date` to `r max_date` on `r ifelse(is.null(params$wiki), "all wikis", paste(params$wiki, collapse = ", "))`. There were `r length(params$test_group_names)` test groups: `r paste(params$test_group_names, collapse = ", ")`. This report includes `r paste(params$event_source, collapse = ", ")` searches. Refer to Phabricator ticket [`r params$phab_ticket`](`r paste0("https://phabricator.wikimedia.org/", params$phab_ticket)`) for more details.

## Data Clean-up

`r data_cleansing_info`

`r if (exists("fulltext_from_auto")) { fulltext_from_auto_cleansing_info }`

## Data Summary {.tabset}

Select one of these three tabs:

### Test Summary {.tabset}

```{r summary_table, results='asis'}
dplyr::data_frame(
  Days = length(unique(events$date)),
  Events = nrow(events),
  Sessions = length(unique(events$session_id)),
  `Page IDs` = length(unique(events$page_id)),
  SERPs = sum(events$event == "searchResultPage"),
  `Unique search queries` = length(unique(paste(events$session_id, events$query_hash))),
  # ^ includes other events besides SERP
  Searches = length(unique(events$search_id[!is.na(events$search_id)])),
  `Same-wiki clicks` = sum(events$event == "click"),
  `Other clicks` = sum(grepl("click", events$event) & events$event != "click")
) %>%
  sapply(., prettyNum, big.mark = ",") %>%
  t() %>%
  knitr::kable()
```

Select one of these sub-tabs:

#### Events

*Event type* identifies the context in which the event was created. Every time a new search is performed a **searchResultPage** event is created. When the user **clicks** a link in the results a **visitPage** event is created. When the user has [dwelled](https://en.wikipedia.org/wiki/Dwell_time_(information_retrieval)) for N seconds a **checkin** event occurs. If the user clicks an interwiki result provided by [TextCat](https://www.mediawiki.org/wiki/TextCat) language detection, there is a **iwclick** event. If the user clicks on a [sister search](https://www.mediawiki.org/wiki/Cross-wiki_Search_Result_Improvements) result from the sidebar, that's an **ssclick.** If the user interacts with a result to explore similar (pages, categories, translations), there are **hover-on**, **hover-off**, and **esclick** events.

![](reports/figures/event_count_all.png)

```{r event_count_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/event_count_wiki.png)")
```

![](reports/figures/event_after_click_all.png)

```{r event_after_click_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/event_after_click_wiki.png)")
```

#### Searches

```{r searches_summary}
sketch_searches_summary <- htmltools::withTags(table(
  DT::tableHeader(c("", names(searches_summary_table))),
  DT::tableFooter(c(rep("",3), names(searches_summary_table)[3:4]))
))
DT::datatable(
  searches_summary_table,
  container = sketch_searches_summary,
  filter = "top",
  extensions = "Buttons",
  options = list(
    pageLength = 10, autoWidth = TRUE, language = list(search = "Filter:"),
    order = list(list(1, "asc")), dom = "Bfrtip", buttons = c("copy", "csv"),
    footerCallback = DT::JS(
      "function( tfoot, data, start, end, display ) {",
      "var api = this.api(), data;",
      "$( api.column(3).footer()).html('Total:  '+",
      "api.column(3).data().reduce( function ( a, b ) {",
      "return a + b;",
      "} )",
      ");",
      "$( api.column(4).footer()).html('Total: '+",
      "api.column(4).data().reduce( function ( a, b ) {",
      "return a + b;",
      "} )",
      ");",
      "}")
  )
)
```

![](reports/figures/daily_searches.png)

#### Searches with _n_ same-wiki results returned

![](reports/figures/n_results_summary_all.png)

```{r n_results_summary_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/n_results_summary_wiki.png)")
```

`r if (exists("serp_offset")) { "#### SERPs by offset" }`

```{r serp_offset_summary_all, eval=exists("serp_offset"), results='asis'}
cat("![](reports/figures/serp_offset_summary_all.png)")
```

```{r serp_offset_summary_wiki, eval=(exists("serp_offset") & n_wiki > 1), results='asis'}
cat("![](reports/figures/serp_offset_summary_wiki.png)")
```

`r if ("user_agent" %in% names(events)) { "#### Browser & OS" }`

`r if ("user_agent" %in% names(events)) { " The goal here is to see whether the proportions of operating system (OS) and browser usage are similar between the groups. To aid decision making, [Bayes factor](https://en.wikipedia.org/wiki/Bayes_factor) is computed for each row. If one group has very different OS/browser share breakdown (Bayes factor > 2), there might be something wrong with the implementation that caused or is causing the sampling to bias in favor of some OSes/browsers. **Note** that for brevity, we show only the top 10 OSes/browsers, and that we don't *actually* expect the numbers to be different so this is included purely as a diagnostic. " }`

`r if ("user_agent" %in% names(events)) { "**Operating systems:**" }`

```{r os_table, eval=("user_agent" %in% names(events))}
DT::datatable(
  os_summary,
  filter = "top",
  extensions = "Buttons",
  options = list(
    pageLength = 10, autoWidth = TRUE, language = list(search = "Filter:"),
    order = list(list(1, "asc")), dom = "Bfrtip", buttons = c("copy", "csv"),
    columnDefs = list(list(
      targets = os_summary_counts_cols_index,
      render = DT::JS(
        "function(data, type, row) {",
        "if ( type === 'type' || type === 'sort' ) {",
        "return data.toString().replace(/\\s\\([0-9]+\\)/g, '');",
        "} else {",
        "return data;",
        "}",
        "}")
    ))
  )) %>% 
  DT::formatStyle(
    'Bayes Factor',
    target = 'row',
    backgroundColor = DT::styleInterval(2, c('transparent', 'yellow'))
  )
```

`r if ("user_agent" %in% names(events)) { "**Browsers:**" }`

```{r browser_table, eval=("user_agent" %in% names(events))}
DT::datatable(
  browser_summary,
  filter = "top",
  extensions = "Buttons",
  options = list(
    pageLength = 10, autoWidth = TRUE, language = list(search = "Filter:"),
    order = list(list(1, "asc")), dom = "Bfrtip", buttons = c("copy", "csv"),
    columnDefs = list(list(
      targets = browser_summary_counts_cols_index,
      render = DT::JS(
        "function(data, type, row) {",
        "if ( type === 'type' || type === 'sort' ) {",
        "return data.toString().replace(/\\s\\([0-9]+\\)/g, '');",
        "} else {",
        "return data;",
        "}",
        "}")
    ))
  )) %>% 
  DT::formatStyle(
    'Bayes Factor',
    target = 'row',
    backgroundColor = DT::styleInterval(2, c('transparent', 'yellow'))
  )
```

`r if (any(exists("serp_iw"), exists("ssclick_des"), "ssclick" %in% events$event, "iwclick" %in% events$event)) { "### Sister Search {.tabset}" }`

`r if (any(exists("serp_iw"), exists("ssclick_des"), "ssclick" %in% events$event, "iwclick" %in% events$event)) { "Select one of these sub-tabs:" }`

`r if (exists("serp_iw")) { "#### Sidebar results by source and position" }`

`r if (exists("serp_iw")) { knitr::kable(ss_results_summary) }`

```{r serp_iw_breakdown_all, eval=exists("serp_iw"), results='asis'}
cat("![](reports/figures/serp_iw_breakdown_all.png)")
```

```{r serp_iw_breakdown_wiki, eval=(exists("serp_iw") & n_wiki > 1), results='asis'}
cat("![](reports/figures/serp_iw_breakdown_wiki.png)")
```

```{r serp_iw_na, eval=exists("serp_iw"), results='asis'}
cat("![](reports/figures/serp_iw_na.png)")
```

`r if (exists("ssclick_des")) { "#### Clicks by project" }`

```{r ssclick_project_all, eval=exists("ssclick_des"), results='asis'}
cat("![](reports/figures/ssclick_project_all.png)")
```

```{r ssclick_project_wiki, eval=(exists("ssclick_des") & n_wiki > 1), results='asis'}
cat("![](reports/figures/ssclick_project_wiki.png)")
```

`r if ("ssclick" %in% events$event) { "#### Clicks by position" }`

```{r ssclick_position_all, eval=("ssclick" %in% events$event), results='asis'}
cat("![](reports/figures/ssclick_position_all.png)")
```

```{r ssclick_position_wiki, eval=("ssclick" %in% events$event & n_wiki > 1), results='asis'}
cat("![](reports/figures/ssclick_position_wiki.png)")
```

`r if ("iwclick" %in% events$event) { "#### Inter-wiki clicks by position" }`

```{r iwclick_position_all, eval=("iwclick" %in% events$event), results='asis'}
cat("![](reports/figures/iwclick_position_all.png)")
```

`r if ("iwclick" %in% events$event & n_wiki > 1 & iwclick_wiki < 2) { paste(" Only", iwclick_wiki_names, "has iwclicks. ") }`

```{r iwclick_position_wiki, eval=("iwclick" %in% events$event & iwclick_wiki > 1), results='asis'}
cat("![](reports/figures/iwclick_position_wiki.png)")
```

`r if (any(exists("esclick_result"), exists("hover_over"))) { "### Explore Similar {.tabset}" }`

`r if (any(exists("esclick_result"), exists("hover_over"))) { "Select one of these sub-tabs:" }`

`r if (exists("esclick_result")) { "#### Clicks by section and link's position on search result page" }`

`r if (exists("esclick_result")) { knitr::kable(esclick_summary) }`

```{r esclick_breakdown_all, eval=exists("esclick_result"), results='asis'}
cat("![](reports/figures/esclick_breakdown_all.png)")
```

```{r esclick_breakdown_wiki, eval=(exists("esclick_result") & n_wiki > 1), results='asis'}
cat("![](reports/figures/esclick_breakdown_wiki.png)")
```

`r if (exists("hover_over")) { "#### Hover-overs by section and results" }`

`r if (exists("hover_over")) { knitr::kable(hover_summary) }`

```{r hover_breakdown_all, eval=exists("hover_over"), results='asis'}
cat("![](reports/figures/hover_breakdown_all.png)")
```

```{r hover_breakdown_wiki, eval=(exists("hover_over") & n_wiki > 1), results='asis'}
cat("![](reports/figures/hover_breakdown_wiki.png)")
```

```{r daily_hover_rate, eval=(all(c("hover-on", "hover-off") %in% events$event) & !is.null(events$event_extraParams)), results='asis'}
cat("![](reports/figures/daily_hover_rate.png)")
```

## Results of Statistical Analysis

### Same-wiki Zero Results Rate

![](reports/figures/zrr_all.png)

```{r zrr_wiki, eval=n_wiki > 1, results='asis'}
cat("![](reports/figures/zrr_wiki.png)")
```

![](reports/figures/daily_zrr.png)

### Same-wiki Engagement

![](reports/figures/engagement_all.png)

```{r engagement_OR_all, results='asis', include=TRUE}
for (this_group in test_group) {
  cat("**", this_group, " vs. ", control_group, "** \n", sep = "")
  cat("![](reports/figures/", this_group, "_engagement_OR_all.png)", sep = "")
  cat("\n")
}
```

```{r engagement_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/engagement_wiki.png)")
```

```{r engagement_OR_wiki, eval=(n_wiki > 1), results='asis', include=TRUE}
for (this_group in test_group) {
  cat("**", this_group, " vs. ", control_group, " by wiki** \n", sep = "")
  cat("![](reports/figures/", this_group, "_engagement_OR_wiki.png)", sep = "")
  cat("\n")
}
```

```{r daily_ctr, results='asis'}
cat("![](reports/figures/daily_ctr.png)")
```

### First Clicked Same-Wiki Result's Position

![](reports/figures/first_clicked_all.png)

```{r first_clicked_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/first_clicked_wiki.png)")
```

### Maximum Clicked Position for Same-Wiki Results

![](reports/figures/max_clicked_all.png)

```{r max_clicked_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/max_clicked_wiki.png)")
```

### PaulScore

[PaulScore](https://www.mediawiki.org/wiki/Wikimedia_Discovery/Search/Glossary#PaulScore) is a measure of search results' relevancy which takes into account the position of the clicked results, and is computed via the following steps:

#. Pick scoring factor $0 < F < 1$ (larger values of $F$ increase the weight of clicks on lower-ranked results).
#. For $i$-th search session $S_i$ $(i = 1, \ldots, n)$ containing $m$ queries $Q_1, \ldots, Q_m$ and search result sets $\mathbf{R}_1, \ldots, \mathbf{R}_m$:
(#) For each $j$-th search query $Q_j$ with result set $\mathbf{R}_j$, let $\nu_j$ be the query score: $$\nu_j = \sum_{k~\in~\{\text{0-based positions of clicked results in}~\mathbf{R}_j\}} F^k.$$
(#) Let user's average query score $\bar{\nu}_{(i)}$ be $$\bar{\nu}_{(i)} = \frac{1}{m} \sum_{j = 1}^m \nu_j.$$
#. Then the PaulScore is the average of all users' average query scores: $$\text{PaulScore}(F)~=~\frac{1}{n} \sum_{i = 1}^n \bar{\nu}_{(i)}.$$

We can calculate the confidence interval of PaulScore$(F)$ by approximating its distribution via [boostrapping](https://en.wikipedia.org/wiki/Bootstrapping_(statistics)).

![](reports/figures/paulscores_all.png)

```{r paulscores_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/paulscores_wiki.png)")
```

`r if (exists("serp_offset")) { "### Other Pages of the Search Results" }`

```{r search_offset_all, eval=exists("serp_offset"), results='asis'}
cat("![](reports/figures/search_offset_all.png)")
```

```{r search_offset_wiki, eval=(exists("serp_offset") & n_wiki > 1), results='asis'}
cat("![](reports/figures/search_offset_wiki.png)")
```

`r if (exists("visitedPages")) { "### Dwell Time Per Visited Page" }`

```{r survival_visitedPages_all, eval=exists("visitedPages"), results='asis'}
cat("![](reports/figures/survival_visitedPages_all.png)")
```

```{r survival_visitedPages_wiki, eval=(exists("visitedPages") & n_wiki > 1), results='asis'}
cat("![](reports/figures/survival_visitedPages_wiki.png)")
```

`r if (exists("visitedPages")) { "### Scroll on visited pages" }`

```{r scroll_visitedPages_all, eval=exists("visitedPages"), results='asis'}
cat("![](reports/figures/scroll_visitedPages_all.png)")
```

```{r scroll_visitedPages_wiki, eval=(exists("visitedPages") & n_wiki > 1), results='asis'}
cat("![](reports/figures/scroll_visitedPages_wiki.png)")
```

### Search Abandon Rate

![](reports/figures/search_abandon_rate_all.png)

```{r search_abandon_rate_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/search_abandon_rate_wiki.png)")
```

### Scroll on search result page

![](reports/figures/scroll_serp_all.png)

```{r scroll_serp_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/scroll_serp_wiki.png)")
```

`r if (exists("fulltext_from_auto")) { "### Dwell time of search result pages" }`

`r if (exists("fulltext_from_auto")) { "Currently we are only able to track the dwell time of search result pages from autocomplete search." }`

```{r serp_survival_all, eval=exists("fulltext_from_auto"), results='asis'}
cat("![](reports/figures/serp_survival_all.png)")
```

```{r serp_survival_wiki, eval=(exists("fulltext_from_auto") & n_wiki > 1), results='asis'}
cat("![](reports/figures/serp_survival_wiki.png)")
```

### Return Rate

Users may click back to the search result page directly after they clickthrough to an article (within 10 mins). We computed two kinds of return rate:

- Among users with at least a click in their search, the proportion of searches that return to the same search page

- Among users with at least a click in their search session, the proportion of sessions that return to search for different things (different search result page but in the same session)

![](reports/figures/return_rate_all.png)

```{r return_rate_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/return_rate_wiki.png)")
```

### Load time of search results pages

![](reports/figures/serp_loadtime_all.png)

```{r serp_loadtime_wiki, eval=(n_wiki > 1), results='asis'}
cat("![](reports/figures/serp_loadtime_wiki.png)")
```

`r if (!is.null(report_params$interleaved_group_names)) { "## Interleaved test" }`

`r if (!is.null(report_params$interleaved_group_names)) { "We use a technique called interleaving to evaluate the user-perceived relevance of search results from the experimental configuration. In it, each user is their own baseline -- we perform two searches behind the scenes and then interleave them together into a single set of results using the team draft algorithm described by Chapelle et al. (2012). For all the graphs in this section, A refers to control group or the first group in the interleaved group names, B referes to the name in the interleaved group names or the second group in the interleaved group names. For example, if the interleaved group name is 'ltr-i-1024', A is the control group and B is group '1024'; if the interleaved group name is 'ltr-i-20-1024', A is group '20' and B is group '1024'." }`

`r if (!is.null(report_params$interleaved_group_names)) { "### Preference" }`

```{r interleaved_pref_overall, eval=(!is.null(params$interleaved_group_names)), results='asis'}
cat("![](reports/figures/interleaved_pref_overall.png)")
```

```{r interleaved_pref_overall_wiki, eval=(!is.null(params$interleaved_group_names) & n_wiki > 1), results='asis'}
cat("![](reports/figures/interleaved_pref_overall_wiki.png)")
```

```{r interleaved_pref_daily, eval=(!is.null(params$interleaved_group_names)), results='asis'}
cat("![](reports/figures/interleaved_pref_daily.png)")
```

```{r interleaved_pref_daily_wiki, eval=(!is.null(params$interleaved_group_names) & n_wiki > 1), results='asis'}
cat("![](reports/figures/interleaved_pref_daily_wiki.png)")
```

`r if (!is.null(report_params$interleaved_group_names)) { "### Page visit times" }`

```{r interleaved_survival_all, eval=(!is.null(params$interleaved_group_names)), results='asis'}
cat("![](reports/figures/interleaved_survival_all.png)")
```

```{r interleaved_survival_wiki, eval=(!is.null(params$interleaved_group_names) & n_wiki > 1), results='asis', include=TRUE}
for (this_group in params$interleaved_group_names) {
  cat("**", this_group, "** \n", sep = "")
  cat("![](reports/figures/", this_group, "_interleaved_survival_wiki.png)", sep = "")
  cat("\n")
}
```
